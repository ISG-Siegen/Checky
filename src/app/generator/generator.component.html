<div>
    <!-- Introductory section with dividers and a descriptive paragraph -->
    <p-divider styleClass="mt-5" />
    <p class="my-4">
        Use <i>Checky's</i> generator to create and manage checklists. 
        Instructions are provided on creating, editing, and exporting checklists.
    </p>
    <p-divider />
</div>

@if (errorMsg.length > 0) {
    <!-- Display error message if any errors occur -->
    <h3>{{ errorMsg }}</h3>
}

@if (loadingSavedChecklist) {
    <!-- Loading state with skeleton loaders while fetching saved checklist -->
    <p-skeleton height="2rem" class="mt-3" />
    <p-skeleton height="3rem" class="mt-2" />
    <p-skeleton height="1rem" class="my-4" />
    <p-skeleton height="10rem" class="mt-5" />
} @else if (errorMsg.length == 0) {
    <!-- Checklist creation section -->
    <h3>Give Your Checklist a Name:</h3>
    <input type="text" pInputText placeholder="My Awesome Checklist" [(ngModel)]="currentChecklistName">
    
    <p-divider class="mt-3" />
    
    <!-- Search for and add questions -->
    <h3>Add Questions:</h3>
    <p-autoComplete 
        id="questionSearch" 
        [suggestions]="suggestions" 
        (completeMethod)="search($event)" 
        (onSelect)="select($event)" 
        placeholder="Search for archived questions...">
        <ng-template let-item pTemplate="item">
            <h4 [innerHTML]="item.question"></h4>
            <ul>
                <!-- Display related conferences for a question -->
                @for (conf of item.conference; track $index) {
                    <li>{{ conf.conference.name }} - {{ conf.year }}</li>
                }
            </ul>
        </ng-template>
    </p-autoComplete>
    
    <!-- Option to add a new question -->
    <div class="flex flex-column align-items-center">
        <h3>OR</h3>
        <p-button label="New Question" icon="pi pi-plus" (onClick)="addQuestionVisible = true" />
    </div>

    <!-- Display existing questions in a card layout -->
    @for (question of questions; track question.id) {
        <p-card class="block mt-3">
            <ng-template pTemplate="title">
                <!-- Question management actions -->
                <div class="flex">
                    <span>{{ $index + 1 }}</span>
                    <p-button icon="pi pi-arrow-up" [disabled]="$first" (click)="move($index, true)" />
                    <p-button icon="pi pi-arrow-down" [disabled]="$last" (click)="move($index, false)" />
                    <p-button icon="pi pi-pencil" (click)="edit($index)" />
                    <p-button icon="pi pi-trash" (click)="remove($index)" />
                </div>
            </ng-template>
            <h4 [innerHTML]="question.question"></h4>
            <span>Answer Type: {{ question.answerType | answerType }}</span>
        </p-card>
    }

    <!-- Recommendations based on existing questions -->
    @if (questions.length > 0) {
        <div class="flex align-items-center">
            <span>Similar Questions:</span>
            <p-button label="Get new recommendations" (onClick)="fetchRecommendations()" [loading]="fetchRecommendationsLoading" />
        </div>

        <!-- Accordion for recommended questions -->
        <p-accordion [(activeIndex)]="activeRecommendation">
            @for (rQ of recommendedQuestions; track rQ.id) {
                <p-accordionTab>
                    <ng-template pTemplate="header">
                        <p-button label="Add" (onClick)="suggestionAdd($event, rQ, $index)" />
                        <span [innerHTML]="rQ.question"></span>
                    </ng-template>
                    <ul>
                        <!-- Related conferences -->
                        @for (conf of rQ.conference; track $index) {
                            <li>{{ conf.conference.name }} - {{ conf.year }}</li>
                        }
                    </ul>
                </p-accordionTab>
            }
        </p-accordion>
    }

    <!-- ChatGPT-powered recommendations -->
    <div class="flex align-items-center">
        <span>ChatGPT recommends:</span>
        <p-button label="Ask for new questions" (onClick)="fetchGPTRecommendations()" [loading]="fetchGPTRecommendationsLoading" />
    </div>
    <div>
        @for (rQ of recommendedGPTQuestions; track rQ.id) {
            <div>{{ rQ.question }}</div>
        }
        @if (rateLimitNextFree) {
            <!-- Display rate limit message -->
            <div>
                <b>Rate Limit Exceeded!</b>
                <span>Next request available at: {{ rateLimitNextFree | date:'short' }}</span>
            </div>
        }
    </div>

    <!-- Save and export options -->
    <div class="flex">
        <p-button label="Save & Share" (onClick)="saveChecklist()" [loading]="saveChecklistLoading" />
        <p-button label="Export (LaTeX)" (onClick)="generateTex()" [loading]="texGenerationLoading" />
    </div>
    
    <!-- Dialogs for output and sharing -->
    <app-question-editor [(visible)]="addQuestionVisible" header="New Question" (onSave)="addQuestion($event)" />
    <p-dialog [(visible)]="outputDialogVisible">
        <textarea readonly>{{ texOutput }}</textarea>
        <p-button label="Copy" (onClick)="copyTexToClipboard()" />
        <p-button label="Download" (onClick)="downloadTex()" />
    </p-dialog>
    <p-dialog [(visible)]="saveDialogVisible">
        <span>Shareable link for the checklist:</span>
        <input type="text" readonly [value]="currentEditLink" />
        <p-button label="Copy" (onClick)="copyEditLinkToClipboard()" />
    </p-dialog>
    <p-toast />
}
